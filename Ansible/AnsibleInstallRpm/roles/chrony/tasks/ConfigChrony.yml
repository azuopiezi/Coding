---
- name: remove server from chrony.conf
  lineinfile:
    dest: /etc/chrony.conf
    regexp: '^server .* iburst'
    state: absent


- name: set chrony server in chrony.conf
  lineinfile:
    dest: /etc/chrony.conf
    regexp: '^server .* iburst'
    line: 'server {{ chrony_server }} iburst'


    line: '{% for item in groups.Controller %}{% if item == groups.Controller[0] %}server {{ hostvars[item].ansible_host }} iburst{% endif %}{% endfor %}'
  when: ansible_hostname not in groups.Controller[0]


- name: set allow in chrony.conf
  lineinfile:
    dest: /etc/chrony.conf
    regexp: '^allow'
    line: 'allow {{ ansible_ens192.ipv4.network }}/{{ 24 }}'
  notify: restart chrony service


